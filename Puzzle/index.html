<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Drag and Drop Puzzle Game</title>
    <link rel="stylesheet" href="puzzle.css">
</head>

<body>

<div class="pop-up">
    <h2 class="pop-up_message">Congratulations on complete the puzzle.</h2>

    <div class="pop-up_btn-box">
        <button class="pop-up_btn btn-accept" id="new-game">YES!!!</button>
        <button class="pop-up_btn btn-cancel">NO</button>
    </div>
</div>

<div class="container">
    <h1 class="welcome">Welcome, do you wanna play and complete the puzzle?</h1>

    <div class="game-side">

        <div class="puzzle">
            <div class="puzzle_cell-container"></div>
        </div>
        
    </div>

    <div class="stats-side">
        
        <fieldset>
            <legend>Select your level</legend>
            <label>
                <input type="radio" name="difficulty" class="difficulty" value="easy" checked="checked">Easy</br>
            </label>
            <label>
                <input type="radio" name="difficulty" class="difficulty" value="medium">Medium</br>                
            </label>
            <label>
                <input type="radio" name="difficulty" class="difficulty" value="hard">Hard</br>
            </label>

            <h3 class="label-difficulty"></h3>
        </fieldset>
            
        <button id="start">Start Puzzle</button>
        
        <button id="reset">Reset</button>
        
        <button id="hint">Hint</button>

        <div class="clock">
            
            <p class="min-sec">
                <span class="min"></span> : <span class="sec"></span>
            </p>

        </div>

    </div>

    <div class="box">

        <img src="imgs/a1.png" alt="" id="p1" class="puzzle_piece" draggable="true">
        <img src="imgs/c1.png" alt="" id="p2" class="puzzle_piece" draggable="true">
        <img src="imgs/e1.png" alt="" id="p3" class="puzzle_piece" draggable="true">
        <img src="imgs/g1.png" alt="" id="p4" class="puzzle_piece" draggable="true">
        <img src="imgs/i1.png" alt="" id="p5" class="puzzle_piece" draggable="true">

        <img src="imgs/b2.png" alt="" id="p6" class="puzzle_piece" draggable="true">
        <img src="imgs/d2.png" alt="" id="p7" class="puzzle_piece" draggable="true">
        <img src="imgs/f2.png" alt="" id="p8" class="puzzle_piece" draggable="true">
        <img src="imgs/h2.png" alt="" id="p9" class="puzzle_piece" draggable="true">

        <img src="imgs/a3.png" alt="" id="p10" class="puzzle_piece" draggable="true">
        <img src="imgs/c3.png" alt="" id="p11" class="puzzle_piece" draggable="true">
        <img src="imgs/e3.png" alt="" id="p12" class="puzzle_piece" draggable="true">
        <img src="imgs/g3.png" alt="" id="p13" class="puzzle_piece" draggable="true">
        <img src="imgs/i3.png" alt="" id="p14" class="puzzle_piece" draggable="true">

        <img src="imgs/b4.png" alt="" id="p15" class="puzzle_piece" draggable="true">
        <img src="imgs/d4.png" alt="" id="p16" class="puzzle_piece" draggable="true">
        <img src="imgs/f4.png" alt="" id="p17" class="puzzle_piece" draggable="true">
        <img src="imgs/h4.png" alt="" id="p18" class="puzzle_piece" draggable="true">

        <img src="imgs/a5.png" alt="" id="p19" class="puzzle_piece" draggable="true">
        <img src="imgs/c5.png" alt="" id="p20" class="puzzle_piece" draggable="true">
        <img src="imgs/e5.png" alt="" id="p21" class="puzzle_piece" draggable="true">
        <img src="imgs/g5.png" alt="" id="p22" class="puzzle_piece" draggable="true">
        <img src="imgs/i5.png" alt="" id="p23" class="puzzle_piece" draggable="true">

        <img src="imgs/b6.png" alt="" id="p24" class="puzzle_piece" draggable="true">
        <img src="imgs/d6.png" alt="" id="p25" class="puzzle_piece" draggable="true">
        <img src="imgs/f6.png" alt="" id="p26" class="puzzle_piece" draggable="true">
        <img src="imgs/h6.png" alt="" id="p27" class="puzzle_piece" draggable="true">

        <img src="imgs/a7.png" alt="" id="p28" class="puzzle_piece" draggable="true">
        <img src="imgs/c7.png" alt="" id="p29" class="puzzle_piece" draggable="true">
        <img src="imgs/e7.png" alt="" id="p30" class="puzzle_piece" draggable="true">
        <img src="imgs/g7.png" alt="" id="p31" class="puzzle_piece" draggable="true">
        <img src="imgs/i7.png" alt="" id="p32" class="puzzle_piece" draggable="true">

        <img src="imgs/b8.png" alt="" id="p33" class="puzzle_piece" draggable="true">
        <img src="imgs/d8.png" alt="" id="p34" class="puzzle_piece" draggable="true">
        <img src="imgs/f8.png" alt="" id="p35" class="puzzle_piece" draggable="true">
        <img src="imgs/h8.png" alt="" id="p36" class="puzzle_piece" draggable="true">

        <img src="imgs/a9.png" alt="" id="p37" class="puzzle_piece" draggable="true">
        <img src="imgs/c9.png" alt="" id="p38" class="puzzle_piece" draggable="true">
        <img src="imgs/e9.png" alt="" id="p39" class="puzzle_piece" draggable="true">
        <img src="imgs/g9.png" alt="" id="p40" class="puzzle_piece" draggable="true">
        <img src="imgs/i9.png" alt="" id="p41" class="puzzle_piece" draggable="true">
        </div>



</div>


<script>

    'use strict';

    var level;
    var minutes;
    var seconds;
    var set;
    var btnStart = document.getElementById('start');
    var btnReset = document.getElementById('reset');
    var puzzle = document.getElementsByClassName('puzzle_cell-container')[0];
    var pzz = document.getElementsByClassName('puzzle')[0];
    var pieces = document.getElementsByClassName('puzzle_piece');
    var hint = document.getElementById('hint');
    var hintOpp = 0;
    var box = document.getElementsByClassName('box')[0];
    var minUI = document.getElementsByClassName('min')[0];
    var secUI = document.getElementsByClassName('sec')[0];
    var modal = document.getElementsByClassName('pop-up')[0];
    var btnNewGame = document.getElementById('new-game');

    /*********************************
     * RESET COMPONENTS AND FUNCTIONS*
     ********************************/    

    /**
     * Button that resets the game
     */
    btnReset.addEventListener('click', function(e){
        resetAll();
    });

    btnNewGame.addEventListener('click', function(e){
        resetAll();

        modal.style.display = 'none';
    });

    /**
     * Handles all reset capabilities...
     * @return {void}
     */
    function resetAll(){

        showDifficulty();

        showStarts();

        returnPieces();

        resetClock();

        resetHint();
    }

    function showDifficulty(){

        var fieldS = document.getElementsByTagName('fieldset')[0];

        let difficults = document.querySelectorAll('.difficulty');

        for(let x of difficults){
            x.parentNode.style.display = 'block';
        }

        document.querySelector('.label-difficulty').style.display = 'none';
    }

    function showStarts(){

        document.getElementById('reset').style.display = 'none';

        hint.style.display = 'none';

        pzz.style.background = "url('imgs/_Puzzle_solved.png')";

        box.style.display = 'none';

        btnStart.style.display = 'block';
    }

    function returnPieces(){

        var boxI = document.getElementsByClassName('box')[0];

        var pzzCnt = document.getElementsByClassName('puzzle_cell-container')[0]; 

        var piecesI = pzzCnt.querySelectorAll('div img');

        if( piecesI.length > 0 ) {

            for( var i=0; i<piecesI.length; i++ ){
                boxI.appendChild(piecesI[i]);
            }
        }
    }

    function resetClock(){

        clearInterval(set);

        zeroClock();
    }

    function resetHint(){
        setHint();
    }

    function zeroClock(){

        document.querySelector('.min').innerHTML = "";

        document.querySelector('.sec').innerHTML = "";
    }

    function showEndGame(msg){

        var mensaje = modal.querySelector('.pop-up_message');

        mensaje.innerHTML = msg;

        modal.style.display = 'block';

        resetClock();
    }

    /***********************************
     * INITIAL COMPONENTS AND FUNCTIONS*
     **********************************/

    /**
     * Button that triggers the start of the game...
     */
    btnStart.addEventListener('click', function(e){

        level = checkLevel();

        setClock();

        setCountdown();

        setHint();

        document.getElementById('reset').style.display = 'inherit';

        hint.style.display = 'inherit';

        pzz.style.background = "url('imgs/_Puzzle_bg_unsolved.png')";

        box.style.display = 'inline-block';

        this.style.display = 'none';
    });

    /**
     * Array matrix to create the puzzle positions...
     * @type {Array}
     */
    var matriz = [
        ["a1",0,"c1",0,"e1",0,"g1",0,"i1"],
        [0,"b2",0,"d2",0,"f2",0,"h2",0],
        ["a3",0,"c3",0,"e3",0,"g3",0,"i3"],
        [0,"b4",0,"d4",0,"f4",0,"h4",0],
        ["a5",0,"c5",0,"e5",0,"g5",0,"i5"],
        [0,"b6",0,"d6",0,"f6",0,"h6",0],
        ["a7",0,"c7",0,"e7",0,"g7",0,"i7"],
        [0,"b8",0,"d8",0,"f8",0,"h8",0],
        ["a9",0,"c9",0,"e9",0,"g9",0,"i9"]
    ];

    function createPuzzleMatrix() {

        var space = 0;
        var spc = 0;

        for( var i=0; i<matriz.length; i++ ){

            for( var j=0; j<matriz[i].length; j++ ){

                if( matriz[i][j] != 0 ){

                    var el = createPuzzleCell(matriz[i][j],j, i);

                    el.addEventListener('drop', function(e){
                        drop(e);
                    });

                    el.addEventListener('dragover', function(e){
                        allowDrop(e);
                    });

                    puzzle.appendChild(el);

                }
            }
        }
    }

    function createPuzzleCell(number, x, y) {

        var drop = document.createElement('div');

        drop.dataset.cell = "pzl_" + number;

        drop.className = "target";

        switch (y) {
            case 1:
                drop.style.top = '49px';
                break;
            case 2:
                drop.style.top = '98px';
                break;
            case 3:
                drop.style.top = '147px';
                break;
            case 4:
                drop.style.top = '196px';
                break;
            case 5:
                drop.style.top = '245px';
                break;
            case 6:
                drop.style.top = '294px';
                break;
            case 7:
                drop.style.top = '343px';
                break;
            case 8:
                drop.style.top = '392px';
                break;
        }

        switch (x) {
            case 1:
                drop.style.left = '84px';
                break;
            case 2:
                drop.style.left = '168px';
                break;
            case 3:
                drop.style.left = '252px';
                break;
            case 4:
                drop.style.left = '336px';
                break;
            case 5:
                drop.style.left = '420px';
                break;
            case 6:
                drop.style.left = '504px';
                break;
            case 7:
                drop.style.left = '588px';
                break;
            case 8:
                drop.style.left = '672px';
                break;
        }

        return drop;
    }

    function checkLevel(){

        var radios = document.getElementsByClassName('difficulty');

        var value;

        for( var i=0; i<radios.length; i++ ){

            if( radios[i].type === 'radio' && radios[i].checked ){
                value = radios[i].value;
            }
        }

        return value;
    }

    function hideAndShowDifficulty(){

        let fieldS = document.getElementsByTagName('fieldset')[0];

        let difficults = document.querySelectorAll('.difficulty');

        for(let x of difficults){
            x.parentNode.style.display = 'none';
        }

        var labelDifficulty = document.querySelector('.label-difficulty');

        labelDifficulty.style.textAlign = 'center';

        labelDifficulty.style.display = 'block';

        labelDifficulty.innerHTML  = level.toUpperCase();

        fieldS.appendChild(labelDifficulty);
    }

    function setClock(){

        hideAndShowDifficulty();

        if( level == 'easy' ){
            minutes = 15;
        }else if( level == 'medium' ){
            minutes = 8;
        }else{
            minutes = 7;
        }
        seconds = 0;
    }

    function setHint(){

        console.log("Entra");

        if( level == 'easy' ){
            hintOpp = 3;
        }else if( level == 'medium' ){
            hintOpp = 2;
        }else{
            hintOpp = 1;
        }
    }

    function setCountdown(){

        set = setInterval(countdown, 1000);
    }

    function countdown() {

        if( seconds == 0 && minutes >0 ){

            seconds = 60;

            minutes--;
        }

        seconds--;

        showClock(minutes, seconds);

        if( minutes == 0 && seconds == 0 ){

            resetClock();
            
            showEndGame("Time's up, do you wanna play another game?");
        }
    }

    function showClock(min, sec){

        minUI.innerHTML = min;

        if( sec < 10 ){
            sec = '0' + sec;
        }

        secUI.innerHTML = sec;
    }

    /***********************************
     * PLAYING COMPONENTS AND FUNCTIONS*
     **********************************/

    var showPuzzle = function(){

        console.log("Entra con");

        pzz.style.background = "url('imgs/_Puzzle_solved.png')";
    }

    /**
     * Button that hints to solve the puzzle
     */
    hint.addEventListener('mousedown', showPuzzle);

    hint.addEventListener('mouseup', function(e){

        pzz.style.background = "url('imgs/_Puzzle_bg_unsolved.png')";

        if( hintOpp == 1 ) {
            hint.removeEventListener('mousedown', showPuzzle);
        }

        hintOpp--;
    });

    box.addEventListener('drop', function(e) {
        drop(e);
    });

    box.addEventListener('dragover', function(e){
        allowDrop(e);
    });

    function drop(ev){
        
        var data = ev.dataTransfer.getData("text");

        var parent = ev.dataTransfer.getData("parent");

        if ( ev.target.nodeName !== 'IMG' ) {
            ev.target.appendChild(document.getElementById(data));
        }else{
            changePlaces(data, parent, ev.target);
        }

        if( emptyBox() ){

            var cuantos = checkPuzzle();

            if( cuantos >= pieces.length){
                showEndGame("Congratulations on finish the puzzle, do you like to start another game?");
            }
        }
    }

    //Function handle the drag event of every piece...
    function drag_start(ev){

        ev.dataTransfer.setData("text", ev.target.id);
        
        ev.dataTransfer.setData("parent", ev.target.parentNode.dataset.cell);
    }

    function allowDrop(ev){
        ev.preventDefault();
    }

    function piecesDragEvents(){

        for( var i=0; i<pieces.length; i++ ){

            pieces[i].addEventListener('dragstart',  function(e){
                drag_start(e);
            });

            //pieces[i].addEventListener('ondragend', function(e){
                //drag_end(e);
            //});
        }
    }

    function emptyBox(){

        if( document.getElementsByClassName("box")[0].childElementCount > 0 ){
            return false;
        }

        return true;
    }

    /**
     * Function that verifies the matrix and if has be done correctly...
     * @return {number} Return how many ok's the puzzle has...
     */
    function checkPuzzle(){

        var celdas = document.getElementsByClassName('target');

        var count = 0;

        for( var i=0; i<celdas.length; i++ ){
            if( checkCell(celdas[i]) ){
                count++;
            }
        }
        
        return count;
    }

    function checkCell(celda){

        var cadena = celda.dataset.cell;

        var cdnChild = celda.childNodes[0];

        var cont = cdnChild.src;

        if( cadena.slice(cadena.length-2, cadena.length) == cont.slice(cont.length-6, cont.length-4) ){
            return true;
        }

        return false;
    }

    function changePlaces(movido, padre, meta){

        var ini = document.getElementById(movido);

        var padreStr = '[data-cell="' + padre + '"]';

        var padrastro= document.querySelector(padreStr);

        if( padre != 'undefined' ){

            meta.parentElement.appendChild(ini);
            
            padrastro.appendChild(meta);
        }
    }

    createPuzzleMatrix();

    piecesDragEvents();
</script>

</body>
</html>